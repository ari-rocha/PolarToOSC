name: Rust CI
version: 1
env:
  RUSTUP_HOME: /workspace/.rustup
  CARGO_HOME: /workspace/.cargo
  PATH: /workspace/.cargo/bin:${PATH}

steps:
  - name: System prerequisites
    run:
      - apt-get update
      - apt-get install -y curl ca-certificates build-essential pkg-config libssl-dev git

  - name: Install rustup + stable toolchain
    run:
      - |
        if ! command -v rustup >/dev/null 2>&1; then
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --profile minimal --default-toolchain stable
        fi
        rustup set profile minimal || true
        rustup toolchain install stable -c rustc -c cargo || true
        rustup default stable || true

  - name: Show versions
    run:
      - cargo --version || true
      - rustc --version || true

  - name: Build (release)
    run: cargo build --release

  - name: Test
    continue_on_error: true
    run: cargo test --all --all-features